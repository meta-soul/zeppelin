FROM swr.cn-southwest-2.myhuaweicloud.com/dmetasoul-repo/zeppelin-base:v0.0.4

ENV Z_VERSION="0.11.0-SNAPSHOT"

ENV LOG_TAG="[ZEPPELIN_${Z_VERSION}]:" \
    ZEPPELIN_HOME="/opt/zeppelin" \
    HOME="/opt/zeppelin" \
    LANG=en_US.UTF-8 \
    LC_ALL=en_US.UTF-8 \
    JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64 \
    ZEPPELIN_ADDR="0.0.0.0"
USER root
COPY zeppelin-${Z_VERSION}.tar.gz  /tmp/zeppelin-${Z_VERSION}-bin-all.tgz
RUN echo "$LOG_TAG Download Zeppelin binary" && \
    mkdir -p ${ZEPPELIN_HOME} && \
    # wget -nv -O /tmp/zeppelin-${Z_VERSION}-bin-all.tgz https://archive.apache.org/dist/zeppelin/zeppelin-${Z_VERSION}/zeppelin-${Z_VERSION}-bin-all.tgz && \
    tar --strip-components=1 -zxvf  /tmp/zeppelin-${Z_VERSION}-bin-all.tgz -C ${ZEPPELIN_HOME} && \
    rm -f /tmp/zeppelin-${Z_VERSION}-bin-all.tgz && \
    chown -R root:root ${ZEPPELIN_HOME} && \
    mkdir -p ${ZEPPELIN_HOME}/logs ${ZEPPELIN_HOME}/run ${ZEPPELIN_HOME}/webapps && \
    # Allow process to edit /etc/passwd, to create a user entry for zeppelin
    chgrp root /etc/passwd && chmod ug+rw /etc/passwd && \
    # Give access to some specific folders
    chmod -R 775 "${ZEPPELIN_HOME}/logs" "${ZEPPELIN_HOME}/run" "${ZEPPELIN_HOME}/notebook" "${ZEPPELIN_HOME}/conf" && \
    # Allow process to create new folders (e.g. webapps)
    chmod 775 ${ZEPPELIN_HOME} && \
    chmod -R 775 /opt/conda
COPY log4j.properties ${ZEPPELIN_HOME}/conf/
COPY log4j_docker.properties ${ZEPPELIN_HOME}/conf/
COPY log4j2.properties ${ZEPPELIN_HOME}/conf/
COPY log4j2_docker.properties ${ZEPPELIN_HOME}/conf/

RUN  \
    # remove python security issue files
    cd /opt/conda && \
    find . -type f -name "package.json" -delete && \
    find . -type f -name "package-lock.json" -delete && \
    find . -type f -name "*CMakeLists.txt" -delete && \
    find . -type f -name "requirements.txt" -delete && \
    pip uninstall statsmodels -y && \
    pip uninstall bokeh -y && \
    rm lib/python3.9/site-packages/IPython/testing/plugin/pytest_ipdoctest.py && \
    rm lib/python3.9/site-packages/debugpy/_vendored/pydevd/_pydev_runfiles/pydev_runfiles_pytest2.py && \
    rm lib/python3.9/site-packages/pandas/tests/io/sas/test_sas7bdat.py && \
    rm lib/python3.9/site-packages/pandas/tests/io/pytables/test_read.py && \
    rm lib/python3.9/site-packages/pandas/tests/io/excel/test_readers.py && \
    rm lib/python3.9/site-packages/pandas/tests/io/test_common.py && \
    pip install h5py pyhdfs -i https://repo.huaweicloud.com/repository/pypi/simple && \
    pip cache purge

RUN \
    groupadd -g 60000 lakesoul && useradd -u 60000 -g lakesoul -G sudo -m -s /bin/bash lakesoul && \
    sed -i /etc/sudoers -re 's/^%sudo.*/%sudo ALL=(ALL:ALL) NOPASSWD: ALL/g' && \
    sed -i /etc/sudoers -re 's/^root.*/root ALL=(ALL:ALL) NOPASSWD: ALL/g' && \
    sed -i /etc/sudoers -re 's/^#includedir.*/## **Removed the include directive** ##"/g' && \
    echo "lakesoul ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    echo "Customized the sudoers file for passwordless access to the lakesoul user!" && \
    sudo chmod -R 775 /opt/zeppelin && \
    sudo chown -R lakesoul:lakesoul /opt/zeppelin

USER lakesoul

EXPOSE 8080

ENTRYPOINT [ "/usr/bin/tini", "--" ]
WORKDIR ${ZEPPELIN_HOME}
CMD ["bin/zeppelin.sh"]
